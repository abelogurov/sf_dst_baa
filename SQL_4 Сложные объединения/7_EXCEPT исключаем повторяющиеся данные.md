### EXCEPT ИСКЛЮЧАЕМ ПОВТОРЯЮЩИЕСЯ ДАННЫЕ

Предположим, нам нужно узнать, в какие города осуществлялась доставка, за исключением тех, в которых проживают водители.

### ПОПРОБУЙТЕ В METABASE!

1. SELECT
2.          c.city_name /*выбираем столбец city_name*/
3. FROM
4.          sql.shipment s /*из схемы sql и таблицы shipment, задаём таблице алиас s*/
5. JOIN sql.city c ON s.city_id = c.city_id /*внутреннее присоединение из схемы sql таблицы city, задав ей алиас c, по ключам city_id*/

6. EXCEPT /*оператор присоединения*/

7. SELECT
8.          cc.city_name  /*выбираем столбец city_name*/
9. FROM
10.          sql.driver d /*из схемы sql и таблицы driver, задаём таблице алиас d*/
11. JOIN sql.city cc ON d.city_id=cc.city_id /*внутреннее присоединение из схемы sql таблицы city, задав ей алияс cc, по ключам city_id*/
12. ORDER BY 1 /*сортировка по первому столбцу*/

Все водители проживают в городе Memphis, и мы видим, что он не выводится в результате запроса.
Как вы, должно быть, заметили, для решения этой задачи мы использовали оператор EXCEPT.

* [Чтобы лучше понять данный тип присоединения, предлагаем ознакомиться с диаграммой Венна — математическим инструментом, представляющим возможные логические связи между соединёнными наборами данных.](https://drive.google.com/file/d/1DEFuhx9KtV3GHYii5H3wJeLxWAuqpvi4/view?usp=sharing)

Синтаксические правила для оператора EXCEPT такие же, как и для UNION:

- одинаковый тип данных;
- одинаковое количество столбцов;
- одинаковый порядок столбцов согласно типу данных.

Синтаксис выглядит следующим образом:

1. SELECT 
2.          n columns
3. FROM 
4.          table_1

5. EXCEPT

6. SELECT 
7.          n columns
8. FROM 
9.          table_2

Мы уже знаем, как решить такую задачу с использованием LEFT JOIN. Вариант с EXCEPT будет полезен в тех случаях, когда у вас много столбцов и вам не хочется прописывать их равенство в условии для JOIN.

Предположим, у нас есть информация о продажах канцелярского магазина за май и июнь.

Какие-то позиции продавались и в том, и в другом месяце, а какие-то — только в одном. Использовав EXCEPT, мы можем оставить только те товары, которые есть в первом запросе (например, за май), но отсутствуют во втором запросе (например, за июнь).

* [Графически действие оператора можно представить следующим образом:](https://drive.google.com/file/d/1Ozv1TZQTlp7ILbaJvPZi8yOU5wBDvmXr/view?usp=sharing)

Таким образом, при присоединении с помощью EXCEPT мы вывели только те товары, которые были проданы в мае, но не в июне. Чтобы найти продажи по тем позициям, что были реализованы в июне, а в мае — нет, необходимо поменять запросы местами.

### Задание 7.1

Выведите список zip-кодов, которые есть в таблице sql.driver, но отсутствуют в таблице sql.customer. Отсортируйте по возрастанию, столбец к выводу — zip.

1. SELECT 
2.     zip_code zip
3. FROM 
4.     sql.driver
5. EXCEPT 
6. SELECT 
7.     zip zip
8. FROM 
9.     sql.customer
10. ORDER BY 1 