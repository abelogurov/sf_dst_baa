### 4. Фильтрация и агрегатные функции

РАБОТА С ОБЪЕДИНЁННЫМИ ТАБЛИЦАМИ

Соединять таблицы мы научились, теперь давайте научимся получать необходимые данные из нескольких таблиц

Принцип построения запроса и порядок операторов такой же, как и с обычной таблицей.

Вспомним его:

- SELECT... 
- FROM... 
- WHERE... 
- GROUP BY... 
- ORDER BY... 
- LIMIT...

### ФИЛЬТРАЦИЯ ДАННЫХ

К соединённым таблицам применимы функции фильтрации данных.

Например, можно вывести id матчей, в которых команда Arsenal была гостевой.

### ПОПРОБУЙТЕ В METABASE!

1. SELECT 
2.     m.id /*столбец id таблицы m*/
3. FROM
4.     sql.teams t /*таблица teams с алиасом t*/
5.     JOIN sql.matches m ON m.away_team_api_id = t.api_id /*оператор соединения таблиц; таблица matches с алиасом m; условие: away_team_api_id таблицы m равен api_id таблицы t*/
6. WHERE long_name = 'Arsenal' /*long_name таблицы teams имеет значение Arsenal*/

Принципиальное отличие фильтрации данных по соединённым таблицам от аналогичного действия по одиночным таблицам заключается в том, что, фильтруя записи одной таблицы, мы также будем фильтровать и записи другой таблицы, поскольку соединённые на уровне запроса таблицы по сути являются единой таблицей.

Например, результат запроса

1. SELECT 
2. 	m.id id_1,
3. 	m.season,
4. 	t.id id_2,
5. 	t.long_name
6. FROM
7. 	sql.teams t
8. JOIN sql.matches m ON m.away_team_api_id = t.api_id

[можно разделить на две разные части](https://drive.google.com/file/d/1xslUtBsu5fRvgQzhnJkbkfaAh0gfxh7A/view?usp=sharing)

Одна часть — таблица matches с алиасом m, вторая — teams с алиасом t, но после соединения они являются одной таблицей.

Таким образом, если вы отфильтруете данные по одной части таблицы, то другая, соединённая, часть пропадёт вместе с ней.

### Задание 4.1

Напишите запрос, который выведет полное название команды (long_name), количество голов домашней команды (home_goal) и количество голов гостевой команды (away_goal) в матчах, где домашней командой были команды с коротким названием ‘GEN’. 
Отсортируйте запрос по id матча в порядке возрастания.

1. SELECT
2.     t.long_name long_name,
3.     m.home_team_goals home_goal,
4.     m.away_team_goals away_goal
5. FROM
6.     sql.matches m
7.     JOIN sql.teams t ON t.api_id = m.home_team_api_id 
8. WHERE short_name = 'GEN'
9. ORDER BY m.id

Также мы можем отфильтровать записи сразу по двум таблицам.

### ПОПРОБУЙТЕ В METABASE!

Например, можно оставить только записи, в которых короткое название домашней команды GEN и матчи сезона 2008/2009.

Также мы можем отфильтровать записи сразу по двум таблицам.

### ПОПРОБУЙТЕ В METABASE!

Например, можно оставить только записи, в которых короткое название домашней команды GEN и матчи сезона 2008/2009.

1. SELECT * /*выбор всех полей*/
2. FROM    
3.     sql.matches m /*таблица matches с алиасом m*/
4.     JOIN sql.teams t on t.api_id = m.home_team_api_id /*оператор соединения таблиц; таблица teams с алиасом t; условие: home_team_api_id таблицы m равен api_id таблицы t*/
5. WHERE
6.     t.short_name = 'GEN' /*столбец short_name таблицы t имеет значение GEN*/
7.     AND m.season = '2008/2009' /*столбец season таблицы m имеет значение 2008/2009*/

### Задание 4.2

Напишите запрос, чтобы вывести id матчей, короткое название домашней команды (home_short), короткое название гостевой команды (away_short) для матчей сезона 2011/2012, в которых участвовала команда с названием Liverpool.
Отсортируйте по id матча в порядке возрастания.