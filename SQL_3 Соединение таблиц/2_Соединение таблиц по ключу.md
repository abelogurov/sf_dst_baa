### 2. Соединение таблиц по ключу

### ОБЪЕДИНЯЕМ ТАБЛИЦЫ БЕЗ ОПЕРАТОРОВ

Чтобы соединить две таблицы между собой, достаточно записать названия таблиц через запятую в разделе from. Что произойдёт в таком случае?

### ПОПРОБУЙТЕ В METABASE!

1. SELECT * /*выбор всех полей*/
2. FROM
3.     sql.teams, /*таблица с командами*/
4.     sql.matches /*таблица с матчами*/

Каждая запись, которая есть в таблице teams, будет соединена с каждой записью в таблице matches.

[Это действие также называют декартовым произведением таблиц](https://drive.google.com/file/d/1DVFsVfwMJ4xX7-hHVJ7E6JiHnACMdIJQ/view?usp=sharing)

Действительно ли это произведение?

Легко проверить! В исходных таблицах teams и matches было 299 и 25083 записей соответственно. Если соединить каждую запись одной таблицы с каждой записью другой, получится 299 * 25083 записей в итоговой таблице.

Задание 2.1

Напишите запрос, который выведет количество строк соединённой таблицы.

1. SELECT
2.    count(*)
3. FROM
4.     sql.teams,
4.     sql.matches

### 7,499,817

В данном случае соединение таблиц не даёт практической пользы: мы получили очень много записей, которые никак не можем интерпретировать, потому что команды не соответствуют матчам.

Давайте исправим это. В таблице teams есть столбец api_id, а таблица matches содержит столбцы home_team_api_id и away_team_api_id — это ключи таблиц, по которым они соединяются.

Ключ — это поле (столбец) в таблице, которое позволяет однозначно идентифицировать запись (строку).

Чтобы соединить таблицы и получить данные о домашней команде по каждому матчу, добавим условие
where home_team_api_id = api_id.

### ПОПРОБУЙТЕ В METABASE!

1. SELECT * /*выбор всех полей в таблице*/
2. FROM
3.     sql.teams, /*таблица с командами*/
4.     sql.matches /*таблица с матчами*/
5. WHERE home_team_api_id = api_id /*условие: home_team_api_id таблицы matches равен api_id таблицы teams*/

Аналогично можем получить данные о гостевых командах: необходимо изменить условие на
5. where away_team_api_id = api_id.

### ПОПРОБУЙТЕ В METABASE!

1. SELECT * /*выбор всех полей в таблицы*/
2. FROM
3.     sql.teams, /*таблица с командами*/
4.     sql.matches /*таблица с матчами*/
5. WHERE away_team_api_id = api_id /*условие: away_team_api_id таблицы matches равен api_id таблицы teams*/

Итак, мы только что объединили таблицы по ключу.

Вы уже знакомы с ключами по таблице pokemon (там в этой роли выступал столбец id). Ключи нужны для того, чтобы иметь возможность не перепутать между собой различные записи.

Например, у нас есть несколько команд с одинаковым названием: Polonia Bytom, Widzew Łódź и Royal Excel Mouscron — хотя это разные команды, с разными id.
Кроме того, как мы уже смогли убедиться, ключи используются для соединения таблиц между собой.

### Ключи бывают двух основных типов:

- Primary — первичный ключ — служит для идентификации текущей таблицы и, как правило, идёт первым в списке столбцов. Всегда уникален: повторяющихся значений в основной таблице быть не может.
- Foreign — внешний ключ — представляет собой ссылку на другую таблицу.
Как правило, названия ключей имеют «хвост», который позволяет их идентифицировать: например, _id, _rk, _cd, _pk (от primary_key), _fk (от foreign_key) и другие.

### Обратите внимание! В данном датасете ключ api_id таблицы teams может быть использован в разных значениях. Его можно использовать для того, чтобы получить информацию о домашней (home) или гостевой (away) команде.

Вы могли заметить, что в последних двух запросах получилось очень много столбцов. Как и при работе с одиночной таблицей, мы можем выбирать, какие столбцы соединённой таблицы выводить.

С помощью известного нам запроса получим названия команд, игравших домашние матчи, и счёт матчей.

### ПОПРОБУЙТЕ В METABASE!

1. SELECT 
2.     long_name, /*столбец long_name таблицы teams*/
3.     home_team_goals, /*столбец home_team_goals таблицы matches*/
4.     away_team_goals /*столбец away_team_goals таблицы matches*/
5. FROM
6.     sql.teams, /*таблица с командами*/
7.     sql.matches /*таблица с матчами*/
8. WHERE home_team_api_id = api_id /*условие: home_team_api_id таблицы matches равен api_id таблицы teams*/

### Задание 2.2

Напишите запрос, который выведет таблицу с результатами матчей, содержащую:

- названия гостевых команд (long_name);
- количество забитых мячей домашней команды (home_team_goals);
- количество забитых мячей гостевой команды (away_team_goals).

1. SELECT 
2.     long_name, 
3.     home_team_goals as home_team_goals,
4.     away_team_goals as away_team_goals
5. FROM
6.     sql.teams,
7.     sql.matches
8. WHERE away_team_api_id = api_id