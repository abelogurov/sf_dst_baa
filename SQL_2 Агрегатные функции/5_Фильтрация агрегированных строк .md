### 5. Фильтрация агрегированных строк

Если ключевое слово WHERE определяет фильтрацию строк до агрегирования, то для фильтрации уже агрегированных данных применяется ключевое слово HAVING.

### Важно! HAVING обязательно пишется после GROUP BY.

### ПОПРОБУЙТЕ В METABASE!

Выведем типы покемонов и их средний показатель атаки, при этом оставим только тех, у кого средняя атака больше 90.

1. SELECT /*выбор*/
2.    type1 AS primary_type, /*таблица type1; присвоить алиас primary_type*/
3.    AVG(attack) AS avg_attack /*расчёт среднего по столбцу attack; присвоить алиас avg_attack*/
4. FROM sql.pokemon /*из таблицы sql.pokemon*/
5. GROUP BY primary_type /*группировать по столбцу primary_type*/
6. HAVING AVG(attack) > 90 /*фильтровать по среднему значению attack, превышающему 90*/

Попробуйте удалить из запроса вывод второго столбца (со средним показателем атаки).

Что получилось?
Запрос работает и выводит только названия типов, у которых средний показатель атаки выше 90.
В HAVING вы можете использовать все те же условия, что и в WHERE.

### ВМЕСТО РЕЗЮМЕ

В общем виде синтаксис оператора SELECT, с учётом имеющихся на данный момент знаний, представляем следующим образом:

- SELECT [ALL | DISTINCT] список_столбцов|*
- FROM список_имён_таблиц
- [WHERE условие_поиска]
- [GROUP BY список_имён_столбцов]
- [HAVING условие_поиска]
- [ORDER BY имя_столбца [ASC | DESC],…]

### Обратите внимание! В квадратных скобках указаны необязательные предложения: они могут отсутствовать в операторе SELECT.

### Задание 5.1

Напишите запрос, который выведет основной и дополнительный типы покемонов (столбцы primary_type и additional_type) для тех типов, у которых средний показатель атаки больше 100 и максимальный показатель очков здоровья меньше 80.

1. SELECT
2.     type1 AS primary_type,
3.     type2 AS additional_type
4. FROM sql.pokemon
5. GROUP BY 1,2
6. HAVING AVG(attack) > 100 AND MAX(hp) < 80

### Задание 5.2

Напишите запрос, который выводит столбцы с основным типом (primary_type) и числом покемонов этого типа (pokemon_count) для тех покемонов, чьё имя (name) начинается с S.

Оставьте только типы, у которых средний показатель защиты больше 80.

Выведите только ТОП-3 типов по числу покемонов в них.

1. SELECT
2.    type1 AS primary_type,
3.    COUNT(*) AS pokemon_count
4. FROM sql.pokemon
5. WHERE name LIKE 'S%' 
6. GROUP BY 1
7. HAVING AVG(defense) > 80
8. ORDER BY 2 DESC
9. LIMIT 3